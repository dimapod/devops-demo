---
resources:
- name: devops-infra
  type: git
  source:
    uri: https://github.com/dimapod/devops-demo.git

- name: application-rc
  type: s3
  source:
    bucket: dpo-devops
    region_name: eu-central-1
    regexp: gs-spring-boot-(.*).jar
    access_key_id: {{s3-access-key-id}}
    secret_access_key: {{s3-secret-access-key}}

- name: golden-ami-s3
  type: s3
  source:
    bucket: dpo-devops
    region_name: eu-central-1
    versioned_file: base-image-id
    access_key_id: {{s3-access-key-id}}
    secret_access_key: {{s3-secret-access-key}}

- name: application-golden-ami-s3
  type: s3
  source:
    bucket: dpo-devops
    region_name: eu-central-1
    versioned_file: application-image-id
    access_key_id: {{s3-access-key-id}}
    secret_access_key: {{s3-secret-access-key}}

jobs:
- name: QA
  public: true
  serial: true
  plan:
  - get: devops-infra
    trigger: true

  - task: app-tests
    file: devops-infra/concourse/pipeline/build/task_run_tests.yml

  - put: application-rc
    params:
      {file: gs-bundle/target/gs-spring-boot-*.jar}


- name: application-image
  public: true
  serial: true
  plan:
  - get: devops-infra
  - get: golden-ami-s3
    trigger: true
  - get: application-rc
    passed: [QA]
    trigger: true

  - task: build
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: xebiafrance/packer-ansible
          tag: '1.9.4'
      inputs:
        - name: devops-infra
        - name: application-rc
        - name: golden-ami-s3
      outputs:
        - name: golden-application-image
      run:
        path: devops-infra/concourse/pipeline/build/task_build_application_image.sh
    params:
      AWS_ACCESS_KEY_ID: {{s3-access-key-id}}
      AWS_SECRET_ACCESS_KEY: {{s3-secret-access-key}}

  - put: application-golden-ami-s3
    params:
      {file: golden-application-image/application-image-id}
